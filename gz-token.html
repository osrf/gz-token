<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="gz-token">
  <template>
    <style>
      #config {
        max-width: 30em;
        border: 1px solid black;
        padding: 1em;
      }

      #config > div{
        padding-top: 1em;
      }

      #config > div > input{
        float:right;
      }
    </style>
    <iron-ajax
      id='ajax'
      url=''
      handle-as='json'
      on-response='_onAjaxResponse'
      on-error="_onAjaxError"
      debounce-duration='300'>
    </iron-ajax>

    <div id="config"  hidden$=[[!config]]>

      <div><h1>[[title]]</h1></div>

      <div>
        Auth server URL:<input value="{{url::input}}"></input>
      </div>
      <div>
        Auth0 ID:<input value="{{auth0_id::input}}"></input>
      </div>
      <div>
        Auth0 Domain:<input value="{{auth0_domain::input}}"></input>
      </div>
      <div>
        Token: [[token]]
      </div>

      <div>
        <button on-tap="tapLogin">Login</button>
        <button on-tap="tapLogout">Logout</button>
      </div>

    </div>

  </template>

  <!-- AUTH0 -->
  <script src="//cdn.auth0.com/js/lock/10.1.0/lock.min.js"></script>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'gz-token',

      /// Called when widget is attached.
      attached: function() {
        this._createLock();

        const that = this
        // attached happens before the webcomponentsready event, so
        // its a good time to set a listener for it here
        window.addEventListener('WebComponentsReady', function() {
          // allow token aware components to react to login, if
          // the user is logged in but the page is reloading
          if (window.localStorage.getItem(that.username_item) != null &&
              window.localStorage.getItem(that.token_item) != null)
          {
            const username = window.localStorage.getItem(that.username_item)
            const token = window.localStorage.getItem(that.token_item)

            that.fire('login', {user: username, token: token})
          }
        })

        window.addEventListener('register', function(e) {
          // Login when new account was created successfully
          if (e.detail.success) {
            that.tapLogin()
          }
        });

        console.log('gz-token widget attached!')
      },

      /// Request login
      tapLogin: function() {
        if (!this.lock)
        {
          console.error('It\'s not possible to use Auth0, have you set the required fields?')
          return;
        }
        this.lock.show()
      },

      /// Request logout
      tapLogout: function() {
        // Clear local storage
        window.localStorage.removeItem(this.username_item);
        window.localStorage.removeItem(this.token_item);
        window.localStorage.removeItem(this.auth0_token_item);

        // Redirect to main page
        window.location.href = "/"
      },

      /// Callback when ajax gets a response.
      _onAjaxResponse: function(request) {
        let res = this.$.ajax.lastResponse
        const success = res.login == "success" ? true : false
        if (res.success)
        {
          this.token = res.token
          this.username = res.decoded.username

          // Set username for refresh
          window.localStorage.setItem(this.username_item, this.username);
          window.localStorage.setItem(this.token_item, this.token);

          this.fire('login', {user: this.username, token: this.token})
        }
      },

      /// Callback when ajax gets an error.
      _onAjaxError: function(err) {
        console.error(err)
      },

      /// Internal function to send login ajax request.
      _requestLogin: function(profile, auth0_token) {
        let url = this.url
        if (!url.endsWith('/'))
          url += '/'
        url += 'token'
        this.$.ajax.url = url + '?username=' + profile.email

        this.$.ajax.headers.authorization = 'Bearer ' + auth0_token
        this.$.ajax.withCredentials = true
        this.$.ajax.generateRequest()
      },

      /// Callback when auth0_id is changed
      _onAuth0IdChanged: function() {
        this._createLock();
      },

      /// Callback when auth0_id is changed
      _onAuth0DomainChanged: function() {
        this._createLock();
      },

      /// Start Auth0's lock
      _createLock: function() {
        if (this.auth0_id == 'not set' ||
            this.auth0_domain == 'not set' ||
            this.lock != undefined)
        {
          return;
        }

        this.lock = new Auth0Lock(this.auth0_id, this.auth0_domain);

        // This is called after page refresh due to redirect
        const that = this;
        this.lock.on("authenticated", function(authResult) {

          // Set local storage so user is still logged in on refresh
          localStorage.setItem(that.auth0_token_item, authResult.idToken);

          // Login with cloudsim-auth
          that.lock.getProfile(authResult.idToken, function (err, profile) {
            if (err) {
              console.error('There was an error getting the profile: ' +
                  err.message);
              return;
            }

            that._requestLogin(profile, authResult.idToken)
          });
        });

        // When refreshing the page, check if user was already logged in
        var auth0_token = localStorage.getItem(this.auth0_token_item);
        if (auth0_token) {
          this.lock.getProfile(auth0_token, function (err, profile) {
            if (err) {
              console.error('There was an error getting the profile: ' +
                  err.message);
              return;
            }

            that._requestLogin(profile, auth0_token)
          });
        }

      },

      /// Component properties
      properties: {

        /// The title above the widget
        title: {
          type: String,
          value: 'Log into existing account (gz-token)',
          notify: true
        },

        /// Authentication server URL
        url: {
          type: String,
          value: 'https://localhost:5050',
          notify: true
        },

        /// True to show configuration GUI
        config: {
          type: Boolean,
          value: false,
        },

        /// Name of user logged in.
        username: {
          type: String,
          value: 'not set',
          notify: true
        },

        /// Authentication server token for user logged in.
        token: {
          type: String,
          value: 'not set',
          notify: true
        },

        /// Name of item in localStorage which keeps auth0's token.
        auth0_token_item: {
          type: String,
          value: 'cloudsim_auth0_token',
          readonly: true
        },

        /// Name of item in localStorage which keeps username.
        username_item: {
          type: String,
          value: 'cloudsim_username',
          readonly: true
        },

        /// Name of item in localStorage which keeps cloudsim's token.
        token_item: {
          type: String,
          value: 'cloudsim_token',
          readonly: true
        },

        /// Auth0 ID
        auth0_id: {
          type: String,
          value: 'not set',
          notify: true,
          observer: '_onAuth0IdChanged'
        },

        /// Auth0 domain
        auth0_domain: {
          type: String,
          value: 'not set',
          notify: true,
          observer: '_onAuth0DomainChanged'
        },
      }
    })

  })()

  </script>
</dom-module>
