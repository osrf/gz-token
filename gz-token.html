<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="gz-token">
  <template>
    <style>
      #config {
        max-width: 30em;
        border: 1px solid black;
        padding: 1em;
      }

      #config > div{
        padding-top: 1em;
      }

      #config > div > input{
        float:right;
      }
    </style>
    <iron-ajax
      id='ajax'
      url=''
      handle-as='json'
      on-response='hresponse'
      on-error="herror"
      debounce-duration='300'>
    </iron-ajax>

    <div id="config">
      <div><h1>{{title}}</h1></div>
      <div><h4>{{caption}}</h4></div>

      <div id="feedback" style="display:none">
        <span id="feedback_text"/>
      </div>

      <div>
        Auth server URL:<input id=url value="{{url::input}}"></input>
      </div>
      <div>
        Data (JSON):<input id=data value="{{data::input}}"></input>
      </div>
      <div>
        <button on-tap="tapToken" id="buttonToken">token</button>
      </div>
      <div>
        Token: {{token}}
      </div>

      <div>
        <button on-tap="tapLogin" id="buttonLogin">login</button>
        <button on-tap="tapLogout" id="buttonLogout">logout</button>
      </div>
    </div>

  </template>

  <script>

  (function() {
    'use strict';

    Polymer({
      is: 'gz-token',

      tapLogin: function() {
        this.state = 'Requesting login'
        let url = this.url
        if (!url.endsWith('/'))
          url += '/'
        url += 'login'
        this.$.ajax.url = url
        this.$.ajax.withCredentials = true
        this.$.ajax.generateRequest()
      },

      tapLogout: function() {
        // Clear for refresh
        window.localStorage.removeItem("username");
        window.localStorage.removeItem("token");

        if (window.navigator.userAgent.toLowerCase().indexOf("firefox") >= 0) {
          window.location = this.url.replace("https://", "https://toto:fakefake@") + "/logout"
          return;
        }
        this.$.feedback.style.display = 'none'
        this.state = 'Requesting logout'
        this.$.ajax.url = this.url + '/logout'
        this.$.ajax.generateRequest()
      },

      tapToken: function() {
        this.state = 'Getting token'
        this.$.ajax.url = this.url + '/token'
        this.$.ajax.params = JSON.parse(this.data)
        this.$.ajax.withCredentials = true
        this.$.ajax.generateRequest()
      },
      hresponse: function(request) {
        this.$.feedback.style.display = ''

        let res = this.$.ajax.lastResponse

        if (res.login) {
          const success = res.login == "success" ? true : false
          if (!success)
          {
            this.$.feedback.style.color = 'red'
            this.$.feedback_text.textContent = "Fail!"
          }
          else
          {
            this.token = res.token

            // temporary fix for older auth server that returns user instead
            // of username
            if (res.user)
              this.set("username", res.user)
            if (res.username)
              this.set("username", res.username)
            this.$.feedback.style.color = 'blue'
            this.$.feedback_text.textContent = "User \"" + this.username + "\" logged in!"

            // Set username for refresh
            window.localStorage.setItem("username", this.username);
            window.localStorage.setItem("token", this.token);

            this.fire('login', {user: this.username, token: this.token})
          }
        }

        // Fill state
        console.log(request.detail.response)
      },
      herror: function(err) {
        this.fire('logout')
      },
      attached: function() {
        console.log('gz-token widget attached!')
        const that = this
        // attached happens before the webcomponentsready event, so
        // its a good time to set a listener for it here
        window.addEventListener('WebComponentsReady', function() {
          // allow token aware components to react to login, if
          // the user is logged in but the page is reloading
          if (window.localStorage.getItem("username") != null &&
              window.localStorage.getItem("token") != null) {
            const username = window.localStorage.getItem("username")
            const token = window.localStorage.getItem("token")
            that.fire('login', {user: username, token: token})
          }
        })

        window.addEventListener('register', function(e) {
          // Login when new account was created successfully
          if (e.detail.success) {
            that.tapLogin()
          }
        });
      },
      // Triggered when the "config" property is changed
      _configChanged: function(newValue, oldValue) {
        this.$.config.style.display = newValue ? '' : 'none'
      },
      // Triggered when the "loginbutton" property is changed
      _loginbuttonChanged: function(newValue, oldValue) {
        this.$.loginbutton.style.display = newValue ? '' : 'none'
      },
      // Triggered when the "logoutbutton" property is changed
      _logoutbuttonChanged: function(newValue, oldValue) {
        this.$.logoutbutton.style.display = newValue ? '' : 'none'
      },
      properties: {
        // the title above the widget
        title: {
          type: String,
          value: 'Log into existing account (gz-token)',
          notify: true
        },
        // the caption under the title
        caption: {
          type: String,
          value: 'This widget allows the user to log into the system and get identity tokens from the cloudsim-auth server. These tokens are required when performing requests to cloudsim-portal and cloudsim-sim servers. A popup will show up to input username and password.',
          notify: true
        },
        data: {
          type: String,
          value: '{"role":"sim_runner"}',
          notify: true
        },
        url: {
          type: String,
          value: 'https://localhost:5050',
          notify: true
        },
        config: {
          type: Boolean,
          value: false,
          observer: '_configChanged'
        },
        username: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        token: {
          type: String,
          value: '',
          notify: true
        },
      }
    })

  })()

  </script>
</dom-module>
